# 始めに

この記事は、Shougo氏が作製するプラグインを解説する、闇のプラグインシリーズ第1弾になります。
第1弾では、Vim/NeoVimのプラグインマネージャーである、dein.vimを紹介していこうと思います。

https://github.com/Shougo/dein.vim

ただ、紹介するだけなら、ググればいろいろ出てきます。
ですので、dein.vimがプラグインをどのように管理しているのか、読み解いてみようと思います。


<!-- textlint-disable -->

> _自らがVim、もしくはテキストエディタと一体化することを望まないなら、気を付けた方がいい。<br>
深淵(Vim)をのぞく時、深淵(Vim)もまたこちらをのぞいているのだ。_<br>
> <div style="text-align: right">フリードリヒ・ニーチェの名言よりオマージュ</div>

<!-- textlint-enable -->


## `runtimepath`から見るプラグインマネージャー

Vim/NeoVimのプラグインと呼ばれる物は、基本的には`runtimepath`に指定したパスを起点に、特定のディレクトリ内のスクリプトをプラグインと呼んでいます。
これは、GitHubで配布されているプラグインにかかわらず、最初からいくつかの基本プラグインが読み込まれています。

ただ`runtimepath`は、指定したパス内の特定のディレクトリを読み込みに行くという単純な動作のため、
プラグインマネージャーとは、スクリプトを使って`runtimepath`管理をしやすくしている物と思ってください。

また、プラグインマネージャーの機能として、自動でプラグインのインストールと更新をしたり、特定のファイルタイプでプラグインが起動するようなオプションを提供しています。


### では、dein.vimはどうなっているのか。

例外なくdein.vimも`runtimepath`を利用していますが、既存の`runtimepath`を上書きをして高速化を実現しています。
つまり、dein.vimを導入するということは、全体の`runtimepath`の管理をdein.vimで行うことになるのです。
dein.vimはVim/NeoVimが起動するまでのプロセスの妨げにならず、ユーザーがすべてを操作できるように機能が提供されています。

しかし、それらの機能を理解しないで使うということは、宝の持ち腐れになります。
自分がヘルプやソースコードを読んで、こう思いました。
「プラグインをインストールして遅延起動させたいだけなら、ほかのプラグインマネージャーで良い。
Vim/NeoVimを極限まで調整したい人なら、導入していじり倒すべきプラグインマネージャーなのだ。」


## 他のプラグインマネージャーとの比較

それでは、dein.vimがVim/NeoVimを極限まで調整する人向けのプラグインマネージャーということが分ってもらえたと思います。
ですので、少々脱線してほかのプラグインマネージャーも見てみようと思います。


### 組込みのプラグインマネージャー

Vim/NeoVimには、`packages`という組込みのプラグインマネージャーが存在します。
詳しいことは`:h packages`をご覧いただければ分ると思いますが、結果的に`runtimepath`を使用してプラグインを読み込むことに変わりありません。
プラグインマネージャーを使わず、組込みの機能だけを使うという方は、こちらをお使いください。


### NeoVim限定のプラグインマネージャー

最近では、`packages`を使うプラグインマネージャーが出てきています。
その中でも[packer.nvim][2]は有名で、`packages`を使ってプラグイン管理をしています。

NeoVimでは、Luaで設定ができるようになっていて、NeoVimはユーザーならLuaで設定を書くと速くなると言われています。
packer.nvimのコーディングにはLuaが使われているので、NeoVim永住宣言をしている方にピッタリだと思います。


### 大手のプラグインマネージャー

Vim/NeoVimのプラグインマネージャー界隈でも、大手の[vim-plug][3]があります。
こちらは、ワンスクリプトで完結していて、`runtimepath`をセットしたパス内の`autoload/`に配置して、プラグインが配置される場所を指定するだけで使えるミニマルなプラグインマネージャーです。
このプラグインマネージャーは機能がシンプルで初めてVimを触るという方が、プラグインを入れたいと言ったらお勧めするプラグインマネージャーです。

「えっ？  dein.vimの紹介なのに、ほかのプラグインマネージャーをお勧めしちゃうの？」と、思われるかもしれません。
先にも説明した通り、dein.vimはVim/NeoVimを極限まで調整したいユーザーが導入するべきプラグインマネージャーであり、初心者にお勧めするプラグインマネージャーではないのです。
しかし、このvim-plugは設定もシンプルで、難しいところが少ないので、Vimでプラグインを入れてみたいだけならこれで十分なのです。

つまり、対象としているユーザー層が違うのです。


## 高速化の鍵`state_(vim|nvim).vim`と`.cache`

ここからは、dein.vimがどのようにして高速化を実現しているか、紐解いていきたいと思います。


<!-- Links -->
[1]: https://github.com/Shougo/dein.vim
[2]: https://github.com/wbthomason/packer.nvim
[3]: https://github.com/junegunn/vim-plug
