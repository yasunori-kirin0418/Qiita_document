# 始めに

この記事は、Shougo氏が作製するプラグインを解説する、闇のプラグインシリーズ第1弾になります。
第1弾では、Vim/NeoVimのプラグインマネージャーである、dein.vimを紹介していこうと思います。

https://github.com/Shougo/dein.vim

ただ、紹介するだけなら、ググればいろいろ出てきます。
ですので、dein.vimがプラグインをどのように管理しているのか、読み解いてみようと思います。


<!-- textlint-disable -->

> _自らがVim、もしくはテキストエディタと一体化することを望まないなら、気を付けた方がいい。<br>
深淵(Vim)をのぞく時、深淵(Vim)もまたこちらをのぞいているのだ。_<br>
> <div style="text-align: right">フリードリヒ・ニーチェの名言よりオマージュ</div>

<!-- textlint-enable -->


## `runtimepath`から見るプラグインマネージャー

Vim/NeoVimのプラグインと呼ばれる物は、基本的には`runtimepath`に指定したパスを起点に、特定のディレクトリ内のスクリプトをプラグインと呼んでいます。
これは、GitHubで配布されているプラグインにかかわらず、最初からいくつかの基本プラグインが読み込まれています。

ただ`runtimepath`は、指定したパス内の特定のディレクトリを読み込みに行くという単純な動作のため、
プラグインマネージャーとは、スクリプトを使って`runtimepath`管理をしやすくしている物と思ってください。

また、プラグインマネージャーの機能として、自動でプラグインのインストールと更新をしたり、特定のファイルタイプでプラグインが起動するようなオプションを提供しています。


### では、dein.vimはどうなっているのか。

例外なくdein.vimも`runtimepath`を利用していますが、既存の`runtimepath`を上書きをして高速化を実現しています。
つまり、dein.vimを導入するということは、全体の`runtimepath`の管理をdein.vimで行うことになるのです。
dein.vimはVim/NeoVimが起動するまでのプロセスの妨げにならず、ユーザーがすべてを操作できるように機能が提供されています。

しかし、それらの機能を理解しないで使うということは、宝の持ち腐れになります。
自分がヘルプやソースコードを読んで、こう思いました。
「プラグインをインストールして遅延起動させたいだけなら、ほかのプラグインマネージャーで良い。
Vim/NeoVimを極限まで調整したい人なら、導入していじり倒すべきプラグインマネージャーなのだ。」


## 他のプラグインマネージャーとの比較

それでは、dein.vimがVim/NeoVimを極限まで調整する人向けのプラグインマネージャーということが分ってもらえたと思います。
ですので、少々脱線してほかのプラグインマネージャーも見てみようと思います。


### 組込みのプラグインマネージャー

Vim/NeoVimには、`packages`という組込みのプラグインマネージャーが存在します。
詳しいことは`:h packages`をご覧いただければ分ると思いますが、結果的に`runtimepath`を使用してプラグインを読み込むことに変わりありません。
プラグインマネージャーを使わず、組込みの機能だけを使うという方は、こちらをお使いください。


### NeoVim限定のプラグインマネージャー

最近では、`packages`を使うプラグインマネージャーが出てきています。
その中でも[packer.nvim][2]は有名で、`packages`を使ってプラグイン管理をしています。

NeoVimでは、Luaで設定ができるようになっていて、NeoVimユーザーならLuaで設定を書くと速くなると言われています。
packer.nvimのコーディングにはLuaが使われているので、NeoVim永住宣言をしている方にピッタリだと思います。


### 大手のプラグインマネージャー

Vim/NeoVimのプラグインマネージャー界隈でも、大手の[vim-plug][3]があります。
こちらは、ワンスクリプトで完結していて、`runtimepath`をセットしたパス内の`autoload/`に配置して、プラグインがダウンロードされる場所を指定するだけで使えるミニマルなプラグインマネージャーです。
このプラグインマネージャーは機能がシンプルで、Vimを初めて触るという方が、プラグインを入れたいと言ったら、お勧めするプラグインマネージャーです。

「えっ？  dein.vimの紹介なのに、ほかのプラグインマネージャーをお勧めしちゃうの？」と、思われるかもしれません。
先にも説明した通り、dein.vimはVim/NeoVimを極限まで調整したいユーザーが導入するべきプラグインマネージャーであり、初心者にお勧めするプラグインマネージャーではないのです。
しかし、このvim-plugは設定もシンプルで、難しいところが少ないので、Vimでプラグインを入れてみたいだけならこれで十分なのです。

つまり、対象としているユーザー層が違うのです。


## dein.vim\~高速化の鍵\~

ここからは、dein.vimがどのようにして高速化を実現しているか、紐解いていきたいと思います。

今回は、以下の環境で見ていきます。また、インストール手順は、dein.vimのREADMEの通りにしたものとします。

<dl>
    <dt>OS</dt>
    <dd>Linux</dd>
    <dt>Vim or NeoVim</dt>
    <dd>NeoVim</dd>
    <dt>インストール先</dt>
    <dd><code>`~/.cache/dein`</code></dd>
    <dt>プラグイン管理方式</dt>
    <dd>tomlファイル</dd>
</dl>


### no_lazyのプラグインも高速化するマージ機能

tomlファイルでプラグインを管理する場合`dein#load_toml()`を使い、読み込むtomlファイルとオプションを指定します。
オプションでは主に遅延の有無で、2つのtomlファイルを用意ことになると思います。
ここからすでに高速化は始まっていて、最初の鍵になるのは、遅延設定をしていないtomlファイルなのです。

どちらかというと`VimEnter`の後に、プラグインを起動させることが高速化につながるのですが、dein.vimは違います。
遅延設定していないプラグインにこそ、高速化のひと手間を施しているのです。
先に解説した通り、プラグインは`runtimepath`に指定されたパス内のディレクトリにあるスクリプトを読み込むことで、プラグインとして成り立ちます。
この`runtimepath`というのは指定された分だけちゃんと順番に読み込むので、パスの数が多くなればなるほど、読み込みに時間がかかるようになるのです。
遅延設定をしていないプラグインがあった場合、通常ですとプラグインマネージャーがダウンロードしてきたプラグインのディレクトリのパスを指定して、Vimが起動する際に`runtimepath`が順次読み込みにいきます。

しかし、dein.vimでは違います。
遅延設定していないプラグインは`~/.cache/dein/.cache/init.vim/.dein/`[^1]というディレクトリにマージされて、読み込む`runtimepath`の数を少なくしてくれます。
`runtimepath`の読み込みはパス内の読み込むディレクトリをすべて読み込んだあと、次のパスの読み込みに移ります。
この数をdein.vimでは、ディレクトリをマージしてしまうことで少なくしているのですね。
もちろんプラグインによってはマージされたら困るものや、スクリプト名が被ってしまう可能性もありますので、ユーザーが明示的にマージを無効化できます。

toml内でマージしてほしくない場合は、以下のように記述します。

```toml:dein_no_lazy.toml
[[plugins]]
repo = 'user_name/repository_name'
merged = 0
```

マージして読み込むディレクトリを少くしても、読み込むスクリプトが多ければ時間がかかるので、マージ機能を過信しないでください。
あくまで、読み込みを高速化するために、ひと手間処理をしてくれているものと思ってください。


### 設定は`state_nvim.vim`[^2]に集結する。

dein.vimでは、プラグインの読み込みや更新のタイミングでフックして、ユーザーが書いた設定処理を実行できます。
フックについて分りやすいのは以下の記事になります。

https://qiita.com/delphinus/items/cd221a450fd23506e81a


## 注釈

[^1]: .vimrcを読み込んでいる場合、`~/.cache/dein/.cache/.vimrc/.dein/`になります。
[^2]: ファイル名はNeoVim使用時です。Vim使用時は、`state_vim.vim`になります。


<!-- Links -->
[1]: https://github.com/Shougo/dein.vim
[2]: https://github.com/wbthomason/packer.nvim
[3]: https://github.com/junegunn/vim-plug
